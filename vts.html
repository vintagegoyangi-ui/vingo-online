<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Roguelike Card Game - Drag Restore</title>
    <style>
        :root {
            --혁명단: #ff4d4d; --기만: #a335ee; --십다구: #0070dd; --노멀: #44bd32;
        }
        body { background: #05050a; color: white; margin: 0; height: 100vh; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; }

        /* 전투 필드 */
        #battle-field { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        #player-info { position: absolute; top: 20px; left: 20px; text-align: left; }
        .hp-bar-outer { width: 180px; height: 12px; background: #333; border-radius: 6px; overflow: hidden; margin: 5px 0; }
        .hp-fill { height: 100%; transition: width 0.3s; }

        /* 적 캐릭터 및 의도 */
        #enemy-area { text-align: center; }
        #enemy-intent { color: #ffd700; font-weight: bold; margin-bottom: 8px; font-size: 0.9rem; text-shadow: 0 0 5px #000; }
        #enemy-visual { width: 140px; height: 170px; background: #222; border: 3px solid #fff; border-radius: 15px; transition: 0.1s; position: relative; }
        #enemy-visual.hit { transform: scale(0.9); filter: brightness(2); }
        .attr-tag { display: inline-block; padding: 2px 8px; border-radius: 5px; font-size: 0.75rem; margin-top: 5px; font-weight: bold; }

        /* 카드 핸드 (드래그 핵심) */
        #hand-wrapper { height: 260px; display: flex; align-items: center; padding: 0 30px; background: rgba(0,0,0,0.8); border-top: 1px solid #333; overflow-x: auto; }
        .card { 
            width: 120px; height: 180px; margin-right: 12px; border-radius: 10px; border: 3px solid #fff;
            position: relative; cursor: grab; flex-shrink: 0; background-color: #1a1a1a; transition: transform 0.15s;
        }
        .card-cost { position: absolute; top: -8px; left: -8px; width: 28px; height: 28px; background: #007bff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; border: 2px solid #fff; }
        .card-attr-label { position: absolute; top: 5px; right: 5px; font-size: 10px; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
        .card-desc { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.85); padding: 6px; font-size: 11px; border-radius: 0 0 7px 7px; box-sizing: border-box; }
        .ability-text { color: #00ffcc; display: block; margin-top: 2px; font-size: 10px; }

        /* 애니메이션 */
        .throwing { transition: 0.4s ease-in !important; transform: translateY(-700px) scale(0) rotate(20deg) !important; opacity: 0; }
        #log { position: absolute; top: 35%; font-size: 1.8rem; font-weight: bold; color: #fff176; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="battle-field">
    <div id="player-info">
        <div style="font-size: 12px; color:#aaa;">STAGE <span id="stg-num">1</span></div>
        <div style="font-weight:bold;">PLAYER HP</div>
        <div class="hp-bar-outer"><div id="p-hp-fill" class="hp-fill" style="background: #2ecc71; width: 100%;"></div></div>
        <div id="p-energy" style="font-weight:bold; color:#00d2ff;">⚡ 3 / 3</div>
    </div>

    <div id="log"></div>

    <div id="enemy-area">
        <div id="enemy-intent">의도 읽는 중...</div>
        <div id="enemy-visual"></div>
        <div id="enemy-tag" class="attr-tag"></div>
        <div class="hp-bar-outer" style="width: 220px; margin: 10px auto;"><div id="e-hp-fill" class="hp-fill" style="background: #ff4d4d; width: 100%;"></div></div>
    </div>
</div>

<div id="hand-wrapper"></div>

<script>
    const RELATION = {
        "혁명단": { strong: ["기만", "십다구"], mult: 1.5, ability: "[투지] 저체력 시 폭딜" },
        "기만": { strong: ["노멀", "혁명단"], mult: 1.5, ability: "[교란] 회피/코스트 증가" },
        "십다구": { strong: ["노멀", "기만"], mult: 1.5, ability: "[몰입] 드로우/연타 콤보" },
        "노멀": { strong: ["혁명단"], mult: 2.0, ability: "[정석] 안정적 스탯/방어" }
    };

    const CARDS = [
        { name: "혁명 일격", atk: 12, cost: 1, attr: "혁명단" },
        { name: "기만 전술", atk: 8, cost: 1, attr: "기만" },
        { name: "몰입 베기", atk: 10, cost: 1, attr: "십다구" },
        { name: "정석 타격", atk: 15, cost: 2, attr: "노멀" }
    ];

    let p = { hp: 50, mHp: 50, eng: 3, deck: [], hand: [], grave: [], stage: 1 };
    let e = { hp: 40, mHp: 40, attr: "", intent: 8 };

    function start() {
        for(let i=0; i<12; i++) p.deck.push({...CARDS[Math.floor(Math.random()*4)]});
        p.deck.sort(() => Math.random() - 0.5);
        newBattle();
    }

    function newBattle() {
        // 적 속성 고정 (전투 시작 시에만 설정)
        e.attr = Object.keys(RELATION)[Math.floor(Math.random()*4)];
        e.mHp = 30 + (p.stage * 15);
        e.hp = e.mHp;
        p.eng = 3;
        draw(5);
        setIntent();
        update();
    }

    function setIntent() {
        e.intent = 5 + (p.stage * 2);
        document.getElementById('enemy-intent').innerText = `⚠️ 공격 예고: ${e.intent} DMG`;
    }

    function draw(n) {
        for(let i=0; i<n; i++) {
            if(p.deck.length === 0 && p.grave.length > 0) { p.deck = [...p.grave]; p.grave = []; p.deck.sort(() => Math.random() - 0.5); }
            if(p.hand.length < 10 && p.deck.length > 0) p.hand.push(p.deck.pop());
        }
        renderHand();
    }

    // --- 드래그 핸들러 (복구 완료) ---
    function renderHand() {
        const wrap = document.getElementById('hand-wrapper');
        wrap.innerHTML = '';
        p.hand.forEach((c, i) => {
            const div = document.createElement('div');
            div.className = 'card';
            div.style.borderColor = `var(--${c.attr})`;
            div.innerHTML = `
                <div class="card-cost">${c.cost}</div>
                <div class="card-attr-label" style="background:var(--${c.attr})">${c.attr}</div>
                <div class="card-desc">
                    <b>${c.name}</b><br>공격력: ${c.atk}
                    <span class="ability-text">${RELATION[c.attr].ability}</span>
                </div>
            `;
            // 마우스/터치 드래그 이벤트 등록
            div.onmousedown = (ev) => handleDrag(ev, div, i);
            wrap.appendChild(div);
        });
    }

    function handleDrag(eStart, el, idx) {
        let startY = eStart.clientY;
        const onMove = (eMove) => {
            let dy = eMove.clientY - startY;
            if(dy < 0) el.style.transform = `translateY(${dy}px) rotate(${dy/10}deg)`;
        };
        const onUp = (eUp) => {
            if(startY - eUp.clientY > 130) play(idx, el); // 130px 이상 올리면 발사
            else el.style.transform = '';
            window.removeEventListener('mousemove', onMove);
            window.removeEventListener('mouseup', onUp);
        };
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);
    }

    function play(idx, el) {
        const c = p.hand[idx];
        if(p.eng < c.cost) { el.style.transform = ''; return; }

        p.eng -= c.cost;
        let d = c.atk;
        if(RELATION[c.attr].strong.includes(e.attr)) d = Math.floor(d * RELATION[c.attr].mult);

        e.hp -= d;
        el.classList.add('throwing');
        
        setTimeout(() => {
            document.getElementById('enemy-visual').classList.add('hit');
            p.grave.push(p.hand.splice(idx, 1)[0]);
            update(); renderHand();
            setTimeout(() => document.getElementById('enemy-visual').classList.remove('hit'), 100);
            if(e.hp <= 0) { alert("STAGE CLEAR!"); p.stage++; newBattle(); }
        }, 300);
    }

    function update() {
        document.getElementById('p-hp-fill').style.width = (p.hp / p.mHp * 100) + "%";
        document.getElementById('e-hp-fill').style.width = Math.max(0, (e.hp / e.mHp * 100)) + "%";
        document.getElementById('p-energy').innerText = `⚡ ${p.eng} / 3`;
        document.getElementById('stg-num').innerText = p.stage;
        const tag = document.getElementById('enemy-tag');
        tag.innerText = e.attr; tag.style.backgroundColor = `var(--${e.attr})`;
    }

    start();
</script>
</body>
</html>
