<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>VINGO EXPEDITION - TRIAD BATTLE</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { 
            --ex-color: #ff007f; --ssr-color: #ffdf00; --sr-color: #a335ee; --r-color: #0070dd; 
            --bg-color: #050505; --win-color: #2ed573; --lose-color: #ff4757; --norm-color: #777;
            --focus-color: #00ffff; --player-bg: #1e90ff; --enemy-bg: #ff4757;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif !important; }
        body { background-color: var(--bg-color); color: white; display: flex; flex-direction: column; align-items: center; height: 100svh; width: 100%; overflow: hidden; }

        .game-phase { display: none; width: 100%; max-width: 500px; height: 100%; flex-direction: column; }
        .active { display: flex !important; }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .nav-bar { display: grid; grid-template-columns: 1fr 1.5fr 1fr; align-items: center; padding: 10px 15px; background: #111; border-bottom: 1px solid #333; height: 60px; }
        .btn-back { background: #333; padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; color: #fff; cursor: pointer; border: none; font-weight: bold; }
        .nav-title { font-weight: 800; font-size: 0.9rem; color: var(--focus-color); text-align: center; }

        /* ì¹´ë“œ ë””ìì¸ */
        .card-wrapper { width: 95px; flex-shrink: 0; height: 145px; position: relative; transition: transform 0.2s; }
        .card-base { 
            width: 100%; height: 100%; border-radius: 12px; border: 2.5px solid #333; 
            background: #000; overflow: hidden; display: flex; flex-direction: column; position: relative; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .card-img { height: 105px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .card-img img { max-width: 85%; max-height: 85%; object-fit: contain; z-index: 1; }
        .card-txt { height: 40px; background: rgba(0,0,0,0.8); border-top: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .char-name { font-size: 0.65rem; font-weight: 900; white-space: nowrap; }

        .owner-glow-player { box-shadow: 0 0 12px var(--player-bg) inset, 0 0 8px var(--player-bg); border-color: var(--player-bg) !important; }
        .owner-glow-enemy { box-shadow: 0 0 12px var(--enemy-bg) inset, 0 0 8px var(--enemy-bg); border-color: var(--enemy-bg) !important; }

        @keyframes selectedShake { 0%, 100% { transform: translateY(-5px); } 50% { transform: translateY(-10px); } }
        .selected-card { animation: selectedShake 0.6s infinite ease-in-out; z-index: 10; }
        .selected-card .card-base { border-color: #fff !important; box-shadow: 0 0 15px #fff; }

        /* ìŠ¤íƒ¯ ë‹¤ì´ì•„ëª¬ë“œ */
        .stat-diamond-container { position: absolute; bottom: 8px; right: 8px; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .diamond-bg { position: absolute; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); border: 1.5px solid rgba(255, 255, 255, 0.5); transform: rotate(45deg); border-radius: 4px; }
        .stat-val { position: absolute; font-size: 11px; font-weight: 900; color: #fff; z-index: 2; text-shadow: 1px 1px 2px #000; }
        .v-top { top: 1px; } .v-bottom { bottom: 1px; } .v-left { left: 3px; } .v-right { right: 3px; }

        /* ë°°í‹€ í•„ë“œ */
        .battle-grid { 
            display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(3, 150px); 
            gap: 8px; justify-content: center; align-content: center; padding: 15px; 
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%); border-radius: 20px; margin: 10px auto; border: 1px solid #333;
        }
        .grid-slot { border: 1.5px dashed #444; border-radius: 12px; display: flex; align-items: center; justify-content: center; min-height: 145px; cursor: pointer; }

        .hand-area { display: flex; gap: 10px; padding: 10px 15px 30px 15px; min-height: 190px; overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch; }
        .sticky-footer { width: 100%; padding: 15px; background: #111; border-top: 2px solid #333; display: flex; justify-content: center; }
        button.main-btn { padding: 16px; border: none; border-radius: 15px; font-weight: 900; cursor: pointer; color: white; background: linear-gradient(135deg, #4b0082, #ff007f); width: 90%; font-size: 1rem; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 4000; align-items: center; justify-content: center; flex-direction: column; padding: 20px; }
        .modal-content { background: #111; padding: 25px; border-radius: 20px; border: 1px solid #333; width: 100%; max-width: 350px; text-align: center; }
    </style>
</head>
<body>

    <section id="phase-lobby" class="game-phase active">
        <header style="padding: 80px 0 40px 0; text-align: center;">
            <h1 style="font-style: italic; font-size: 2.8rem; background: linear-gradient(to bottom, #fff, #666); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">VINGO EXPEDITION</h1>
            <p style="color:var(--focus-color); letter-spacing: 5px; font-size: 0.8rem; margin-top: 10px;">TRIAD BATTLE SYSTEM</p>
        </header>
        <div style="display: flex; flex-direction: column; gap: 15px; align-items: center; width: 100%;">
            <button class="main-btn" onclick="startNewGame()">âš”ï¸ ì›ì • ì‹œì‘</button>
            <button class="main-btn" style="background: #222; border: 1px solid #444;" onclick="openGuide()">ğŸ“– ê²Œì„ ë°©ë²•</button>
            <button class="main-btn" style="background: #1a1a1a; color: #666;" onclick="location.href='index.html'">ğŸ« ê°€ì± ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </section>

    <div id="guide-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="color:var(--focus-color); margin-bottom:15px; font-style:italic;">GAME RULES</h2>
            <div style="font-size:0.85rem; line-height:1.6; color:#ccc; text-align: left;">
                * 3x3 í•„ë“œì— ì¹´ë“œë¥¼ ë²ˆê°ˆì•„ ë†“ìŠµë‹ˆë‹¤.<br>
                * ë†“ì¸ ì¹´ë“œì˜ ì¸ì ‘í•œ ë©´ì˜ ìˆ«ìë¥¼ ë¹„êµí•©ë‹ˆë‹¤.<br>
                * **ë‚´ ìˆ«ìê°€ ë” í¬ë©´** ìƒëŒ€ ì¹´ë“œë¥¼ ë‚´ ê²ƒìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.<br>
                * í•„ë“œê°€ ê°€ë“ ì°¼ì„ ë•Œ ì¹´ë“œê°€ ë§ì€ ìª½ì´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤.<br>
                * ìŠ¹ë¦¬ ì‹œ ì—ë„ˆì§€ê°€ 1 íšŒë³µë©ë‹ˆë‹¤.
            </div>
            <button class="main-btn" style="margin-top:20px;" onclick="closeModal('guide-modal')">ì•Œê² ì–´!</button>
        </div>
    </div>

    <div id="win-modal" class="modal-overlay">
        <div class="modal-content" style="border-color: var(--win-color);">
            <h1 id="win-title" style="color: var(--win-color); font-style: italic; margin-bottom: 10px;">STAGE CLEAR!</h1>
            <p id="win-desc" style="color: #ccc; font-size: 0.9rem; margin-bottom: 20px;">ì—ë„ˆì§€ê°€ 1 íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <button class="main-btn" id="win-next-btn" style="background: var(--win-color);">ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ</button>
        </div>
    </div>

    <section id="phase-deck" class="game-phase">
        <div class="nav-bar"><button class="btn-back" onclick="location.reload()">â—€ ë©”ì¸</button><div class="nav-title">ì›ì •ëŒ€ ëª¨ì§‘</div><div></div></div>
        <div style="background:#111; padding:12px; border-bottom:1px solid #333; text-align:center; font-weight:800;">
            ì„ ë°œ: <span id="deck-count" style="color:var(--focus-color)">0</span>/5 | CP: <span id="deck-cost" style="color:var(--ex-color)">25</span>
        </div>
        <div style="flex:1; overflow-y:auto; padding:20px;"><div id="deck-grid" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;"></div></div>
        <div class="sticky-footer"><button id="btn-to-battle" class="main-btn" disabled onclick="startBattlePhase()">ëª¨ì§‘ ì™„ë£Œ</button></div>
    </section>

    <section id="phase-battle" class="game-phase">
        <div class="nav-bar">
            <button class="btn-back" onclick="location.reload()">â—€ ë©”ì¸</button>
            <div id="stage-display" class="nav-title">STAGE 1</div>
            <div id="score-display" style="font-weight:900; font-size:1.1rem; text-align:right; color:var(--focus-color);">5 : 5</div>
        </div>
        <div class="battle-grid" id="battle-grid"></div>
        <div style="margin-top:auto; width: 100%;">
            <div style="display:flex; justify-content:space-between; align-items:center; padding: 0 20px; margin-bottom:5px;">
                <div id="turn-display" style="font-size:0.7rem; font-weight:900; padding:4px 12px; border-radius:20px; background:var(--player-bg);">MY TURN</div>
            </div>
            <div class="hand-area" id="player-hand"></div>
        </div>
    </section>

    <div id="card-modal" class="modal-overlay">
        <div id="modal-content-area"></div>
        <div style="display:flex; flex-direction:column; gap:10px; width:220px; margin-top:20px;">
            <button id="modal-confirm" class="main-btn">ì„ ë°œí•˜ê¸°</button>
            <button onclick="closeModal('card-modal')" style="background: #222; padding:12px; border-radius:12px; color:white; border:none; font-weight:bold;">ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <script src="card_data.js"></script>
    <script src="battle_engine.js"></script>

    <script>
    // 1. Firebase ì´ˆê¸°í™”
    const firebaseConfig = {
        apiKey: "AIzaSyBOmMyRoAZ57YQVWaiiLDLVE5Lwu5aU9-4",
        authDomain: "vingo-expedition.firebaseapp.com",
        databaseURL: "https://vingo-expedition-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "vingo-expedition",
        storageBucket: "vingo-expedition.firebasestorage.app",
        messagingSenderId: "593803537592",
        appId: "1:593803537592:web:d076b2b34a410d144e584d"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let USER_ID = null;
    let myInventory = []; 
    let currentEnergy = { count: 30, last: null };
    let gameState = { playerDeck: [], battleHand: [], enemyDeck: [], grid: Array(9).fill(null), currentStage: 1, turn: 'player', selectedHandIdx: null };

    const SETTINGS = { 
        "EX": { cp: 10, color: "#ff007f", rank: 0, bg: "radial-gradient(circle, rgba(255,0,127,0.6), #000)" }, 
        "SSR": { cp: 7, color: "#ffdf00", rank: 1, bg: "radial-gradient(circle, rgba(255,223,0,0.5), #000)" }, 
        "SR": { cp: 4, color: "#a335ee", rank: 2, bg: "radial-gradient(circle, rgba(163,53,238,0.5), #000)" }, 
        "R": { cp: 2, color: "#0070dd", rank: 3, bg: "radial-gradient(circle, rgba(0,112,221,0.5), #000)" } 
    };

    // 2. ë³´ì•ˆ ë° ë¡œê·¸ì¸ ì²´í¬
    window.onload = async () => {
        USER_ID = localStorage.getItem('vingo_user_id');
        if (!USER_ID) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
            location.href = 'index.html';
            return;
        }
        await loadUserData();
    };

    async function loadUserData() {
        const snapshot = await db.ref('users/' + USER_ID).once('value');
        const data = snapshot.val();
        if (data) {
            myInventory = Array.isArray(data.inventory) ? data.inventory : [];
            currentEnergy = data.energy || { count: 30, last: Date.now() };
            if (data.battleSave) {
                gameState.currentStage = data.battleSave.stage || 1;
                gameState.playerDeck = data.battleSave.playerDeck || [];
            }
        }
        renderDeckBuilding();
    }

    // 3. ì¹´ë“œ ë°°ì¹˜ ë° ë°°í‹€ ë¡œì§
    function placeCard(idx) {
        if(gameState.turn !== 'player' || gameState.selectedHandIdx === null || gameState.grid[idx]) return;
        
        const card = gameState.battleHand[gameState.selectedHandIdx];
        gameState.grid[idx] = JSON.parse(JSON.stringify(card));
        gameState.battleHand.splice(gameState.selectedHandIdx, 1);
        gameState.selectedHandIdx = null;

        // BattleEngineì„ í†µí•œ ì¹´ë“œ ë’¤ì§‘ê¸° ì²˜ë¦¬
        if(window.BattleEngine) {
            BattleEngine.processTurn(gameState.grid, idx);
        }

        renderBattleBoard();
        renderPlayerHand();

        if(!checkEnd()) {
            gameState.turn = 'enemy';
            updateBattleUI();
            setTimeout(enemyAction, 800);
        }
    }

    async function checkEnd() {
        if(gameState.grid.every(v => v !== null)) {
            const score = BattleEngine.getScore(gameState.grid);
            const p = score.player + gameState.battleHand.length;
            const e = score.enemy + gameState.enemyDeck.length;
            
            setTimeout(() => {
                if(p > e) showWinModal();
                else { alert("ì›ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤..."); location.reload(); }
            }, 500);
            return true;
        }
        return false;
    }

    async function showWinModal() {
        const modal = document.getElementById('win-modal');
        const title = document.getElementById('win-title');
        const desc = document.getElementById('win-desc');
        const btn = document.getElementById('win-next-btn');

        if (gameState.currentStage >= 10) {
            title.innerText = "FINAL VICTORY!";
            title.style.color = "var(--ssr-color)";
            desc.innerText = "ëª¨ë“  ì›ì •ì„ ëëƒˆìŠµë‹ˆë‹¤! ì¶•í•˜í•©ë‹ˆë‹¤!";
            btn.innerText = "ë©”ì¸ìœ¼ë¡œ";
            btn.onclick = () => location.reload();
            confetti({ particleCount: 200, spread: 70, origin: { y: 0.6 } });
        } else {
            title.innerText = `STAGE ${gameState.currentStage} CLEAR!`;
            desc.innerText = "âš¡ï¸ ë³´ìƒìœ¼ë¡œ ì—ë„ˆì§€ê°€ 1 íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.";
            btn.onclick = async () => {
                gameState.currentStage++;
                await saveWinProgress();
                closeModal('win-modal');
                initBattle();
            };
        }
        modal.style.display = 'flex';
    }

    async function saveWinProgress() {
        currentEnergy.count = Math.min(30, currentEnergy.count + 1);
        await db.ref('users/' + USER_ID).update({
            energy: currentEnergy,
            battleSave: { stage: gameState.currentStage, playerDeck: gameState.playerDeck }
        });
    }

    // --- ê¸°íƒ€ ì—”ì§„ í•¨ìˆ˜ (ë””ìì¸ ìœ ì§€) ---
    function createCardUI(u, id, owner = null, isLarge = false) {
        const wrap = document.createElement('div');
        const grade = id.split('_')[0];
        const conf = SETTINGS[grade];
        wrap.className = isLarge ? `modal-card-view` : `card-wrapper`;
        let ownerClass = (owner === 'player') ? "owner-glow-player" : (owner === 'enemy' ? "owner-glow-enemy" : "");
        wrap.innerHTML = `<div class="card-base ${ownerClass}" style="border-color:${conf.color}">
            <div class="card-img" style="background:${conf.bg}"><img src="images/${id}">${getDiamondHTML(u.stats)}</div>
            <div class="card-txt"><div class="char-name" style="color:${conf.color}">${u.name}</div></div>
        </div>`;
        return wrap;
    }

    function getDiamondHTML(stats) {
        const ds = stats.map(s => s === 10 ? 'A' : s);
        return `<div class="stat-diamond-container">
            <div class="diamond-bg"></div>
            <div class="stat-val v-top">${ds[0]}</div><div class="stat-val v-bottom">${ds[1]}</div>
            <div class="stat-val v-left">${ds[2]}</div><div class="stat-val v-right">${ds[3]}</div>
        </div>`;
    }

    function renderBattleBoard() {
        const board = document.getElementById('battle-grid'); board.innerHTML = "";
        gameState.grid.forEach((card, idx) => {
            const slot = document.createElement('div'); slot.className = 'grid-slot';
            if(card) slot.appendChild(createCardUI(card, card.id, card.owner));
            else slot.onclick = () => placeCard(idx);
            board.appendChild(slot);
        });
        updateScore();
    }

    function renderPlayerHand() {
        const hand = document.getElementById('player-hand'); hand.innerHTML = "";
        gameState.battleHand.forEach((card, idx) => {
            const ui = createCardUI(card, card.id, 'player');
            if(gameState.selectedHandIdx === idx) ui.classList.add('selected-card');
            ui.onclick = () => { gameState.selectedHandIdx = idx; renderPlayerHand(); };
            hand.appendChild(ui);
        });
    }

    function enemyAction() {
        const move = BattleEngine.getBestMove(gameState.grid, gameState.enemyDeck);
        if(!move) return;
        const card = gameState.enemyDeck[move.handIdx];
        gameState.grid[move.targetSlot] = JSON.parse(JSON.stringify(card));
        gameState.enemyDeck.splice(move.handIdx, 1);
        BattleEngine.processTurn(gameState.grid, move.targetSlot);
        renderBattleBoard();
        if(!checkEnd()) { gameState.turn = 'player'; updateBattleUI(); }
    }

    function updateScore() {
        const score = BattleEngine.getScore(gameState.grid);
        document.getElementById('score-display').innerText = `${score.player + gameState.battleHand.length} : ${score.enemy + gameState.enemyDeck.length}`;
    }

    function updateBattleUI() {
        document.getElementById('stage-display').innerText = `STAGE ${gameState.currentStage}`;
        const turnDisp = document.getElementById('turn-display');
        turnDisp.innerText = (gameState.turn === 'player') ? "MY TURN" : "ENEMY TURN";
        turnDisp.style.background = (gameState.turn === 'player') ? "var(--player-bg)" : "var(--enemy-bg)";
    }

    function renderDeckBuilding() {
        const grid = document.getElementById('deck-grid'); grid.innerHTML = "";
        myInventory.forEach(item => {
            const info = CARD_DATA_DB[item.id];
            if(info) {
                const card = createCardUI(info, item.id);
                if(gameState.playerDeck.find(d => d.id === item.id)) card.classList.add('selected-card');
                card.onclick = () => openDeckModal(info, item.id);
                grid.appendChild(card);
            }
        });
        updateDeckStats();
    }

    function updateDeckStats() {
        const count = gameState.playerDeck.length;
        const cost = gameState.playerDeck.reduce((sum, c) => sum + SETTINGS[c.id.split('_')[0]].cp, 0);
        document.getElementById('deck-count').innerText = count;
        document.getElementById('deck-cost').innerText = 25 - cost;
        document.getElementById('btn-to-battle').disabled = (count !== 5);
    }

    function startNewGame() { goToPhase('phase-deck'); renderDeckBuilding(); }
    function startBattlePhase() { 
        gameState.grid = Array(9).fill(null);
        gameState.battleHand = JSON.parse(JSON.stringify(gameState.playerDeck)).map(c => ({...c, owner: 'player'}));
        gameState.enemyDeck = Array(5).fill(0).map(() => {
            const ak = Object.keys(CARD_DATA_DB);
            const rk = ak[Math.floor(Math.random() * ak.length)];
            return { id: rk, ...CARD_DATA_DB[rk], owner: 'enemy' };
        });
        renderBattleBoard(); renderPlayerHand(); updateBattleUI(); goToPhase('phase-battle'); 
    }
    function goToPhase(id) { document.querySelectorAll('.game-phase').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    function openGuide() { document.getElementById('guide-modal').style.display = 'flex'; }
    function openDeckModal(u, id) {
        const modal = document.getElementById('card-modal');
        document.getElementById('modal-content-area').innerHTML = "";
        document.getElementById('modal-content-area').appendChild(createCardUI(u, id, null, true));
        const isSelected = gameState.playerDeck.findIndex(d => d.id === id) > -1;
        const btn = document.getElementById('modal-confirm');
        btn.innerText = isSelected ? "ì„ ë°œ ì œì™¸" : "ì›ì •ëŒ€ ì„ ë°œ";
        btn.onclick = () => {
            if(isSelected) gameState.playerDeck = gameState.playerDeck.filter(d => d.id !== id);
            else {
                if(gameState.playerDeck.length >= 5) return alert("ìµœëŒ€ 5ì¥ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                if(gameState.playerDeck.reduce((s,c)=>s+SETTINGS[c.id.split('_')[0]].cp, 0) + SETTINGS[id.split('_')[0]].cp > 25) return alert("CPê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
                gameState.playerDeck.push({ id, ...u });
            }
            renderDeckBuilding(); closeModal('card-modal');
        };
        modal.style.display = "flex";
    }
    </script>
</body>
</html>
