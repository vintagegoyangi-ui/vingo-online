<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>VINGO EXPEDITION v2.1 (Custom Login)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <script src="card_data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBOmMyRoAZ57YQVWaiiLDLVE5Lwu5aU9-4",
            authDomain: "vingo-expedition.firebaseapp.com",
            databaseURL: "https://vingo-expedition-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "vingo-expedition",
            storageBucket: "vingo-expedition.firebasestorage.app",
            messagingSenderId: "593803537592",
            appId: "1:593803537592:web:d076b2b34a410d144e584d"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let USER_ID = null; // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì‚¬ìš©ìì˜ ì•„ì´ë”” ì €ì¥

        // [ì»¤ìŠ¤í…€ ë¡œê·¸ì¸ ë¡œì§]
        async function handleAuth(type) {
            const id = document.getElementById('auth-id').value.trim();
            const pw = document.getElementById('auth-pw').value.trim();

            if (!id || !pw) { alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }

            const userRef = db.ref('users/' + id);
            const snapshot = await userRef.once('value');
            const userData = snapshot.val();

            if (type === 'signup') {
                // íšŒì›ê°€ì…
                if (userData) {
                    alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.");
                } else {
                    await userRef.set({
                        password: pw, // ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„  ì•”í˜¸í™”ê°€ í•„ìš”í•˜ì§€ë§Œ, í˜„ì¬ëŠ” í‰ë¬¸ ì €ì¥
                        inventory: [],
                        energy: { count: 30, last: Date.now() }
                    });
                    alert("ğŸ‰ íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”.");
                }
            } else {
                // ë¡œê·¸ì¸
                if (userData && userData.password === pw) {
                    USER_ID = id;
                    alert(USER_ID + "ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!");
                    document.getElementById('login-layer').style.display = 'none';
                    document.getElementById('main-container').style.display = 'block';
                    loadUserData(userData); // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë°ì´í„° ì ìš©
                } else {
                    alert("ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                }
            }
        }

        function loadUserData(data) {
            myItems = data.inventory || [];
            energy = data.energy || { count: 30, last: null };
            updateEnergyOnLoad();
            updateUI();
            setInterval(updateTimer, 1000);
            console.log("âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", myItems);
        }

        // ì „ì—­ ì €ì¥ í•¨ìˆ˜ (ì´ì œ USER_ID ê²½ë¡œì— ì €ì¥)
        window.cloudSave = function(data) {
            if (!USER_ID) return;
            return db.ref('users/' + USER_ID).update(data) // ì „ì²´ë¥¼ ë®ì–´ì“°ì§€ ì•Šê²Œ update ì‚¬ìš©
                .then(() => console.log("âœ… ì„œë²„ ì €ì¥ ì„±ê³µ"))
                .catch((e) => console.error("âŒ ì €ì¥ ì—ëŸ¬:", e));
        };
    </script>

    <style>
        :root { --ex-color: #ff007f; --ssr-color: #ffdf00; --sr-color: #a335ee; --r-color: #0070dd; --bg-color: #050505; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); color: white; display: flex; flex-direction: column; align-items: center; min-height: 100svh; width: 100%; overflow-x: hidden; }
        
        /* ë¡œê·¸ì¸ ë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
        #login-layer { position: fixed; inset: 0; background: #050505; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .auth-box { width: 100%; max-width: 320px; background: #111; padding: 25px; border-radius: 20px; border: 1px solid #222; }
        .auth-box input { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 12px; border: 1px solid #333; background: #000; color: white; outline: none; }
        .auth-box button { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        
        /* ê¸°ì¡´ ê²Œì„ ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€... */
        .container { width: 92%; max-width: 400px; text-align: center; background: #111; padding: 20px; border-radius: 30px; border: 1px solid #222; margin: 20px auto; display: none; }
        .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        button { padding: 16px; font-weight: bold; border-radius: 15px; border: none; color: white; cursor: pointer; }
        .btn-draw { background: linear-gradient(135deg, #ff4757, #ff6b81); }
        .btn-draw-10 { background: linear-gradient(135deg, #e67e22, #f39c12); }
        .btn-sub { grid-column: span 2; background: #222; border: 1px solid #333; margin-top: 5px; }
    </style>
</head>
<body>
    <div id="login-layer">
        <div class="auth-box">
            <h2 style="color:var(--ssr-color); text-align:center; margin-bottom:20px; font-style:italic;">VINGO LOGIN</h2>
            <input type="text" id="auth-id" placeholder="ì•„ì´ë””">
            <input type="password" id="auth-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button onclick="handleAuth('login')" style="background:var(--r-color);">ë¡œê·¸ì¸</button>
            <button onclick="handleAuth('signup')" style="background:#333;">íšŒì›ê°€ì…</button>
            <p style="font-size:11px; color:#666; text-align:center;">ì•„ì´ë””ê°€ ì—†ìœ¼ë©´ íšŒì›ê°€ì…ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.</p>
        </div>
    </div>

    <div class="container" id="main-container">
        <div id="energy-tag" style="background:#1a1a1a; padding:10px 18px; border-radius:50px; font-weight:bold; margin-bottom:15px; border:1px solid #333; font-size:0.85rem;">
            âš¡ï¸ ì—ë„ˆì§€: <span id="energy-display">-- / --</span> <span id="timer-display"></span>
        </div>
        <div id="result-area">
            <h1 style="font-style: italic; margin-bottom: 20px;">VINGO EXPEDITION</h1>
        </div>
        <div class="btns">
            <button class="btn-draw" onclick="playGacha(1)">1íšŒ ì†Œí™˜</button>
            <button class="btn-draw-10" onclick="playGacha(10)">10íšŒ ì†Œí™˜</button>
            <button class="btn-sub" onclick="openCollection()">ë„ê° í™•ì¸</button>
            <button class="btn-sub" style="background:#4b0082;" onclick="location.href='game.html'">âš”ï¸ ì›ì • ì‹œì‘</button>
        </div>
    </div>

    <script>
        // ê°€ì±  ë° ë¡œì§ ì½”ë“œëŠ” ê¸°ì¡´ v2.1ê³¼ ë™ì¼...
        const MAX_ENERGY = 30;
        let myItems = [];
        let energy = { count: MAX_ENERGY, last: null };

        async function save() {
            if (!USER_ID) return;
            localStorage.setItem('vingo_game_coll', JSON.stringify(myItems));
            localStorage.setItem('vingo_game_en', JSON.stringify(energy));
            // í´ë¼ìš°ë“œ ì €ì¥ ì‹œ passwordëŠ” ì œì™¸í•˜ê³  inventoryì™€ energyë§Œ ì—…ë°ì´íŠ¸
            await window.cloudSave({ inventory: myItems, energy: energy, lastSync: Date.now() });
        }

        async function playGacha(count) {
            if (energy.count < count) { alert("ì—ë„ˆì§€ ë¶€ì¡±!"); return; }
            energy.count -= count;
            const pool = Object.keys(CARD_DATA_DB);
            for(let i=0; i<count; i++){
                const resId = pool[Math.floor(Math.random() * pool.length)];
                const f = myItems.find(item => item.id === resId);
                if (f) f.count++; else myItems.push({id: resId, count: 1});
            }
            updateUI();
            await save();
            alert(count + "íšŒ ì†Œí™˜ ì™„ë£Œ!");
        }

        function updateUI() { document.getElementById('energy-display').innerText = `${energy.count} / ${MAX_ENERGY}`; }
        function updateEnergyOnLoad() { /* íƒ€ì´ë¨¸ ê´€ë ¨ ë¡œì§ */ }
        function updateTimer() { /* íƒ€ì´ë¨¸ ê´€ë ¨ ë¡œì§ */ }
        function openCollection() { /* ë„ê° ë¡œì§ */ }
    </script>
</body>
</html>
