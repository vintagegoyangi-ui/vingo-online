<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>VINGO EXPEDITION - Online Sync</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <script src="card_data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <script>
        // 1. ë³¸ì¸ì˜ Firebase ì„¤ì • (ê·¸ëŒ€ë¡œ ìœ ì§€)
        const firebaseConfig = {
            apiKey: "AIzaSyBOmMyRoAZ57YQVWaiiLDLVE5Lwu5aU9-4",
            authDomain: "vingo-expedition.firebaseapp.com",
            databaseURL: "https://vingo-expedition-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "vingo-expedition",
            storageBucket: "vingo-expedition.firebasestorage.app",
            messagingSenderId: "593803537592",
            appId: "1:593803537592:web:d076b2b34a410d144e584d"
        };

        // 2. ì´ˆê¸°í™” ë¡œì§
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.database();
            const USER_ID = "tester_01"; 

            // ì „ì—­ í•¨ìˆ˜ ë“±ë¡
            window.cloudSave = function(data) {
                console.log("â˜ï¸ ì„œë²„ ì €ì¥ ì‹œë„...");
                return db.ref('users/' + USER_ID).set(data)
                    .then(() => console.log("âœ… ì„œë²„ ì €ì¥ ì„±ê³µ!"))
                    .catch((e) => console.error("âŒ ì €ì¥ ì—ëŸ¬:", e));
            };

            window.cloudLoad = function() {
                console.log("â˜ï¸ ì„œë²„ ë¡œë“œ ì‹œë„...");
                return db.ref('users/' + USER_ID).once('value')
                    .then((snapshot) => snapshot.val())
                    .catch((e) => { console.error("âŒ ë¡œë“œ ì—ëŸ¬:", e); return null; });
            };

            window.isFirebaseReady = true;
            console.log("ğŸš€ [ë°°í¬ í™•ì¸] Firebaseê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (e) {
            console.error("ğŸ”¥ ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
        }
    </script>
    
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ìœ ì§€ */
        :root { --ex-color: #ff007f; --ssr-color: #ffdf00; --sr-color: #a335ee; --r-color: #0070dd; --bg-color: #050505; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); color: white; display: flex; flex-direction: column; align-items: center; min-height: 100svh; width: 100%; overflow-x: hidden; margin: 0; }
        .container { width: 92%; max-width: 400px; text-align: center; background: #111; padding: 20px; border-radius: 30px; border: 1px solid #222; margin: 20px auto; }
        .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        button { padding: 16px; font-weight: bold; border: none; border-radius: 15px; cursor: pointer; color: white; }
        .btn-draw { background: linear-gradient(135deg, #ff4757, #ff6b81); }
        .btn-draw-10 { background: linear-gradient(135deg, #e67e22, #f39c12); }
        .btn-sub { grid-column: span 2; background: #222; border: 1px solid #333; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="energy-tag" style="background:#1a1a1a; padding:10px; border-radius:50px; border:1px solid #333;">
            âš¡ï¸ ì—ë„ˆì§€: <span id="energy-display">-- / --</span>
        </div>
        <h1>VINGO ONLINE</h1>
        <p style="color:#666; font-size:0.8rem;">Vercel ë°°í¬ ë²„ì „</p>
        <div class="btns">
            <button class="btn-draw" onclick="playGacha(1)">1íšŒ ì†Œí™˜</button>
            <button class="btn-draw-10" onclick="playGacha(10)">10íšŒ ì†Œí™˜</button>
            <button class="btn-sub" style="background:#4b0082;" onclick="location.href='game.html'">âš”ï¸ ì›ì • ì‹œì‘</button>
        </div>
    </div>

    <script>
        const MAX_ENERGY = 30;
        let myItems = [];
        let energy = { count: MAX_ENERGY, last: null };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í´ë¼ìš°ë“œ ë™ê¸°í™”
        window.onload = function() {
            const checkReady = setInterval(function() {
                if (window.isFirebaseReady) {
                    clearInterval(checkReady);
                    window.cloudLoad().then(data => {
                        if (data) {
                            myItems = data.inventory || [];
                            energy = data.energy || { count: MAX_ENERGY, last: null };
                            console.log("âœ… ì„œë²„ ë™ê¸°í™” ì™„ë£Œ");
                        } else {
                            console.log("ğŸ  ì„œë²„ ë°ì´í„° ì—†ìŒ");
                            myItems = JSON.parse(localStorage.getItem('vingo_game_coll')) || [];
                            energy = JSON.parse(localStorage.getItem('vingo_game_en')) || { count: MAX_ENERGY, last: null };
                        }
                        updateUI();
                    });
                }
            }, 100);
        };

        async function save() {
            localStorage.setItem('vingo_game_coll', JSON.stringify(myItems));
            localStorage.setItem('vingo_game_en', JSON.stringify(energy));
            if (window.cloudSave) {
                await window.cloudSave({ inventory: myItems, energy: energy, lastSync: Date.now() });
            }
        }

        async function playGacha(count) {
            energy.count -= count;
            const pool = Object.keys(CARD_DATA_DB);
            for(let i=0; i<count; i++) {
                const resId = pool[Math.floor(Math.random() * pool.length)];
                const f = myItems.find(item => item.id === resId);
                if (f) f.count++; else myItems.push({id: resId, count: 1});
            }
            updateUI();
            await save();
            alert("ì†Œí™˜ ì„±ê³µ! ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function updateUI() {
            document.getElementById('energy-display').innerText = `${energy.count} / ${MAX_ENERGY}`;
        }
    </script>
</body>
</html>
